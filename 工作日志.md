# 工作日志

## 账号密码记录

### **WIFI密码**

yiwenqi

Yiwenqi520086.

### oracle 

​	账号：406254709@qq.com

​	密码：yiwenqi520086.

### 数据库密码：

​		host：10.141.0.234

​		username： root

​		password：shumeiShumei2016

### confulence ：

账号：yiwenqi@ishumei.com

密码：Yiwenqi520086

### console.ishumei.com

账号：

密码：

### jira

账号：yiwenqi@ishumei.com	

密码:   Yiwenqi520086	

### grafana

账号：rd

密码：Rd@shumei.COM (区分大小写)

### dbm.ishumei.com

密码WiFi密码：

账号：yiwenqi

密码：Yiwenqi520086.

### sentry

账号：yiwenqi@ishumei.com	

密码：yiwenqi520086

cf.ishumei.com

账号：yiwenqi@ishumei.com	

密码:   Yiwenqi520086

## 日常记录

### 2022/01/05

#### 外网地址

背景：

在堡垒机上我们使用的是内网ip地址，当我们想要访问时需要访问内网ip地址；：

查看外网地址：curl ifconfig.me

#### 查询进程号

ps -ef | grep XXX

#### 查询端口号

先查询进程号 pid

netstat -nap | grep pid

### 2022/01/06

#### main-interface 测试数据

```shell
curl -d '{"accessKey":"w989k1xh45HgIxDlYre6","appId":"default","eventId":"register","data":{"tokenId":"d64e481f93b158a7862a2c5571be99765","ip":"111.85.43.52","timestamp":1465810229852,"deviceId":"20200713114032c3b42f11e39f2257cafc43c4f830e477b2323244","phone":"18435107168","os":"ios","appVersion":"1.2.0.6",,"nickName":"英俊的小帅哥","gpsLocation":{"gpsLongtitude":205.1237659,"gpsLatitude":201.9182758},"signupPlatform":"qq","email":"abcd@ishumei.com"}}' http://localhost:7880/v2/event
```

```shell
curl -d '{"eventId":"wg_check","type":"POLITICS_VIOLENCE_BAN_PORN_LOGO_OCR_AD","data":{"tokenId":"dongxin@wegooooo.com","imgs":[{"img":"http://nbjjh-gate-io.szwego.com/20210516/a1621126515791_4866.jpg?imageView2/2/w/640/h/640/format/jpg","btId":"wg1"},{"img":"http://nbxs-gate-io.szwego.com/20210516/a1621126516082_4481.jpg?imageView2/2/w/640/h/640/format/jpg","btId":"wg2"},{"img":"http://nbjjh-gate-io.szwego.com/20210516/a1621126516366_0473.jpg?imageView2/2/w/640/h/640/format/jpg","btId":"wg3"},{"img":"http://nbxs-gate-io.szwego.com/20210516/a1621126516666_4353.jpg?imageView2/2/w/640/h/640/format/jpg","btId":"wg4"},{"img":"http://nbjjh-gate-io.szwego.com/20210516/a1621126515499_8081.jpg?imageView2/2/w/640/h/640/format/jpg","btId":"wg5"},{"img":"http://nbxs-gate-io.szwego.com/20210516/a1621126516966_4150.jpg?imageView2/2/w/640/h/640/format/jpg","btId":"wg6"}]},"accessKey":"CE0cxVpm3cKwyB6NVc0B","appId":"default"}' http://localhost:7880/images/v4
```





#### jira流程：

sentry 找公司的 组织标识，或accesskey

fenkongcloud找集群

去集群上找日志



## 新人入职：

### 数据库了解

#### 连接线上环境下的数据库

mysql -h 10.66.103.118 -u smselect -psmselect2019

#### saas_router_mapping

- 查询数据库 saas/saas_router_mapping

  - 查询语句:

  ```mysql
  select url, serviceid, re_zk_name, config,default_value, timeout, request_limit from saas_router_mapping where state=1;
  ```

  *  注意`where`中的条件
    * state = 1
  * 查询字段

  ```mysql
  url, serviceid, re_zk_name, config, default_value,timeout,request_limit
  
      url 请求的 uri
      serviceId 此 uri 所属的服务 id
      re_zk_name 请求派发到 RE 时，所依据的 ZK 节点名
      default_value 如果业务请求失败，或者超时，返回的结果
      timeout 请求 RE 的超时时间（ms）
      request_limit 是否开启单日请求限额，1：开启；0：关闭
      state 此条路由配置的状态，1：开启；0：关闭
  ```
  
  - 主要查询结论：re_zk_name字段列表

  | re_zk_name          | value          |
  | ------------------- | -------------- |
  | re-posteven         | 请求事件       |
  | re-tianxiang        |                |
  | re-image            | 图片请求       |
  | re-text             | 文本请求       |
  | re-finance          | 财产请求       |
  | re-cloudconf        |                |
  | re-file             | 文件请求       |
  | re-captcha          | 验证码请求     |
  | re-video            | 视频请求       |
  | re-voice            | 声频请求       |
  | re-fengkong         | 风控请求       |
  | re-audio-message    | 声音-信息请求  |
  | re-videostreamaudio | 视频流中的声音 |
  | re-recommend        | 推荐？         |
  | re-audit            | 审计           |
  | re-rtasr            |                |
  | re-recognition      | **识别**       |
  
  经查验：config 全为空

  ```mysql
  select url, serviceid, re_zk_name, config,default_value, timeout, request_limit from saas_router_mapping where state=1 and config ="Channel"  limit 10;
  ```
  

#### saas/saas_accesskey

- 查询数据库：saas/saas_accesskey

  - 查询语句:

    ```mysql
    select access_key,secret_key,organization,check_sign from saas_accesskey where status=1;
    ```

  - 注意： `where` 中的条件 status = 1；
  - 查询字段

  ```mysql
  access_key,secret_key,organization,check_sign
  // access_key  访问key
  // secret_key  安全key
  // organization 
  // check_sign   0/1   （1 :开启accessKey 到 accKeyCheckSign 的映射）
  ```

  - 主要查询结论

| access_key           | secret_key                               | organization         | check_sign |
| -------------------- | ---------------------------------------- | -------------------- | ---------- |
| n97Aicv5UtBuhWkZTtg1 | dUt4CFEaxDrkdYkVAgrVatQRPAg9uXA8iuClzHVw | n97Aicv5UtBuhWkZTtg1 | 0          |
| SPeQeGk85QzyqoP0QfWB | XERTjs3NY0OggtxVziu5yt3phjPxZcymgQGZJ9c7 | SPeQeGk85QzyqoP0QfWB | 0          |
| h8KuAI1SsUhLrXttkW7h | rYHokpxh5grNOBHPK97CuPOlcHeX3MEVaMJVBHC7 | h8KuAI1SsUhLrXttkW7h | 0          |

​			注意：经过查验，得到 check_sign 全部为 0；



- 查询数据库：saas/saas_tenant 和 saas/saas_tenant_service

  - 查询语句：

  ```mysql
  select st.organization,sts.service from saas_tenant as st join saas_tenant_service as sts on st.organization=sts.organization where st.status=1 and sts.status=\"NORMAL\";
  ```

  ​	注意 `sts.status = \"\" `需要进行转义

  - 查询字段：

  ```mysql
  ssaas_tenant.organization,saas_tenant.service
  // organization     organization
  // service          serviceId
  ```

  - 主要查询结果（3种代表）：

| organization         | service     （代码中映射为serviceId） |
| -------------------- | ------------------------------------- |
| 01TPw39RYRUatjnYXN56 | ACCOUNT_LOGIN                         |
| LCaNrT3Zq2PZJI5GFgIx | POST_TEXT_EN                          |
| 0Mx9ysXy17owXnbxAEnX | POST_AUDIO                            |
| qPog4AlXiztJGsXmjhEf | DEVICE_PROFILE                        |
| VO5XEIL8XgdkxYEWkSP6 | POST_IMG                              |



#### saas_main_dispatch_table

- 查询数据库：`saas_main_dispatch_table`  
- 查询语句：SELECT `url`, `lvs`, `dispatch_key` FROM `saas_main_dispatch_table`  limit 10;

```mysql
+---------------------------------+-----+-----------------------+
| url                             | lvs | dispatch_key          |
+---------------------------------+-----+-----------------------+
| /v2/saas/anti_fraud/audiostream | lc  | voice_host_list       |
| /v3/saas/anti_fraud/videostream | lc  | videostream_host_list |
| /videostream/v4                 | lc  | videostream_host_list |
+---------------------------------+-----+-----------------------+

```

字段说明：

- url 为 路由路径
- lvs 为调度策略
- dispatch_key 转发到哪一个 RE

### 主接口中的 `LocalCache` 的作用

用于存放appid，那么为何要用本地缓存来存储appid？

首先我们明确appid使用于鉴权，那么我们就应该知道每条请求进来都需要鉴权，而每天主接口处理大量的请求，如果每次都去数据库获取appid对于数据库的压力是非常大的，因此使用缓存进行获取，且每隔30秒进行一次数据appid的获取，这样既能保证数据同步，也能减轻数据库的压力。





## 流程介绍

### 修改数据库

 登录`dbm.ishumei.com`,提交工单

开发测试环境下测试sql语句，sql语句使用严格模式

等待审核，审核成功。

查看 `grafana` 中的集群状态---CPU,请求量等状态。

### GIT

查看当前分支：git branch

查看所有分支：git branch -a

切换分支:  git checkout 分支名

新建本地分支：git branch 分支名

新建本地分支并切换到新建分支： git checkout 分支名

将本地分支与远程分支绑定 ：  git push --set-upstream origin dev/unittest

注意：dev/unittest 为新建分支名，意思是远程新建一个分支与当前分支绑定

**问题修复**

- 问题出现

```bash
fatal unable to access 'https //github.com
```

分析原因：

设置了`http.proxy`代理，输入`git config --global --unset http.proxy`即可

- OpenSSl

```bash
OpenSSL SSL_read: Connection was reset, errno 10054
```

分析原因：

解决方案：

```bash
git config --global http.sslVerify "false" 
```

